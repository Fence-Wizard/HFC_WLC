{% extends "base.html" %}

{% block title %}Step 2 - Geometry | HFC Construction Calculator{% endblock %}

{% block progress %}
<div class="progress-bar">
  <div class="progress-bar-inner">
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Wind</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step active">
      <span class="progress-dot">2</span>
      <span>Geometry</span>
    </div>
    <div class="progress-connector"></div>
    <div class="progress-step">
      <span class="progress-dot">3</span>
      <span>Job Info</span>
    </div>
    <div class="progress-connector"></div>
    <div class="progress-step">
      <span class="progress-dot">4</span>
      <span>Results</span>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<form method="post" action="/step3" id="step2Form" novalidate>
  <!-- Carry forward step 1 data -->
  <input type="hidden" name="zip_code" value="{{ data.zip_code }}" />
  <input type="hidden" name="risk_category" value="{{ data.risk_category }}" />
  <input type="hidden" name="wind_speed_mph" value="{{ data.wind_speed_mph }}" />
  <input type="hidden" name="exposure" value="{{ data.exposure }}" />

  <div class="card">
    <div class="card-header">
      <h2>Step 2 - Fence Geometry</h2>
      <p>Define the fence dimensions and post configuration for this section.</p>
    </div>

    <div class="form-group">
      <label for="height_total_ft">Total Fence Height (ft) *</label>
      <input
        type="number"
        id="height_total_ft"
        name="height_total_ft"
        step="0.5"
        min="3"
        max="50"
        value="{{ data.height_total_ft or '' }}"
        placeholder="e.g. 8"
        required
      />
      <span class="form-hint">
        Top of fabric to ground line, in feet.
      </span>
      <span class="form-error" id="err_height"></span>
    </div>

    <div class="form-group">
      <label for="post_spacing_ft">Post Spacing (ft) *</label>
      <input
        type="number"
        id="post_spacing_ft"
        name="post_spacing_ft"
        step="0.5"
        min="1"
        max="30"
        value="{{ data.post_spacing_ft or '' }}"
        placeholder="e.g. 10"
        required
      />
      <span class="form-hint">
        On-center distance between posts. Common: 8 ft or 10 ft.
      </span>
      <span class="form-error" id="err_spacing"></span>
    </div>

    <div class="form-group">
      <label for="fence_length_ft">Fence Run Length (ft)</label>
      <input
        type="number"
        id="fence_length_ft"
        name="fence_length_ft"
        step="1"
        min="1"
        max="10000"
        value="{{ data.fence_length_ft or '' }}"
        placeholder="e.g. 200 (optional)"
      />
      <span class="form-hint">
        Total length of this fence run. Used to compute B/s aspect ratio
        for the force coefficient (Cf). Leave blank for long runs (&ge; 20x height).
      </span>
    </div>

    <div class="form-group">
      <label for="fence_type">Fence Type</label>
      <select id="fence_type" name="fence_type">
        {% for ft in fence_options %}
        <option
          value="{{ ft.key }}"
          {% if data.fence_type==ft.key %}selected{% endif %}
        >{{ ft.label }}</option>
        {% endfor %}
      </select>
      <span class="form-hint">
        Determines the solidity ratio and force coefficient (Cf).
        Open chain link sees much less wind load than a solid panel.
      </span>
    </div>

    <div class="form-group">
      <label for="line_post_key">Line Post (ASTM F1083 Group IC)</label>
      <select id="line_post_key" name="line_post_key">
        <option value="auto" {% if not data.line_post_key or data.line_post_key=='auto' %}selected{% endif %}>
          Auto - select by bending capacity
        </option>
        {% for opt in post_options %}
        <option
          value="{{ opt.key }}"
          {% if data.line_post_key==opt.key %}selected{% endif %}
        >{{ opt.label }}</option>
        {% endfor %}
      </select>
      <span class="form-hint">
        Intermediate posts along the fence run. "Auto" picks the lightest
        adequate pipe.
      </span>
    </div>

    <div class="form-group">
      <label for="terminal_post_key">Terminal / Corner / Gate Post</label>
      <select id="terminal_post_key" name="terminal_post_key">
        <option value="auto" {% if not data.terminal_post_key or data.terminal_post_key=='auto' %}selected{% endif %}>
          Auto - select by bending capacity
        </option>
        {% for opt in post_options %}
        <option
          value="{{ opt.key }}"
          {% if data.terminal_post_key==opt.key %}selected{% endif %}
        >{{ opt.label }}</option>
        {% endfor %}
      </select>
      <span class="form-hint">
        End posts, corner posts, and gate posts (cantilever model).
        Typically one or two sizes larger than the line post.
      </span>
    </div>

    <details style="margin-top: 1rem;">
      <summary style="font-weight: 600; cursor: pointer;">Footing &amp; Gate Options</summary>
      <div class="detail-content" style="margin-top: 0.75rem;">
        <div class="form-group">
          <label for="embedment_depth_in">Embedment Depth Override (inches)</label>
          <input
            type="number"
            id="embedment_depth_in"
            name="embedment_depth_in"
            step="1"
            min="12"
            max="120"
            value="{{ data.embedment_depth_in or '' }}"
            placeholder="Leave blank for catalog default"
          />
          <span class="form-hint">
            Override the default embedment depth from the post catalog.
            Used in the footing lateral resistance check (IBC 1807.3).
          </span>
        </div>

        <div class="form-group">
          <label for="footing_diameter_in">Footing Diameter Override (inches)</label>
          <input
            type="number"
            id="footing_diameter_in"
            name="footing_diameter_in"
            step="1"
            min="6"
            max="60"
            value="{{ data.footing_diameter_in or '' }}"
            placeholder="Leave blank for catalog default"
          />
          <span class="form-hint">
            Override the default footing diameter. Larger footings increase
            soil resistance and concrete volume.
          </span>
        </div>

        <div style="display: flex; gap: 1rem;">
          <div class="form-group" style="flex: 1;">
            <label for="num_gates">Gate Openings</label>
            <input
              type="number"
              id="num_gates"
              name="num_gates"
              min="0"
              max="20"
              value="{{ data.num_gates or '0' }}"
            />
            <span class="form-hint">Each gate needs 2 gate posts.</span>
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="num_corners">Corner Posts</label>
            <input
              type="number"
              id="num_corners"
              name="num_corners"
              min="0"
              max="50"
              value="{{ data.num_corners or '0' }}"
            />
            <span class="form-hint">Number of 90&deg; corners.</span>
          </div>
        </div>
      </div>
    </details>

    <div class="info-card">
      <strong>Understanding Post Spacing</strong>
      <p>
        The wind-load tables give a <b>maximum allowable spacing</b> for
        each post size at the entered wind speed and height. The calculator
        will compare your requested spacing against those limits and flag
        any overage.
      </p>
      <p class="muted">
        Shorter spacing = lower load per post = lighter hardware.
      </p>
    </div>

    <div class="btn-group">
      <a href="/" class="btn btn-secondary">&larr; Back</a>
      <button type="submit" class="btn btn-primary btn-lg">
        Next &rarr;
      </button>
    </div>
  </div>
</form>

<script>
// Client-side validation
document.getElementById('step2Form').addEventListener('submit', function(e) {
  let valid = true;
  const height = document.getElementById('height_total_ft');
  const spacing = document.getElementById('post_spacing_ft');
  const errH = document.getElementById('err_height');
  const errS = document.getElementById('err_spacing');
  errH.textContent = '';
  errS.textContent = '';

  const hVal = parseFloat(height.value);
  if (isNaN(hVal) || hVal < 3 || hVal > 50) {
    errH.textContent = 'Height must be between 3 and 50 ft.';
    valid = false;
  }
  const sVal = parseFloat(spacing.value);
  if (isNaN(sVal) || sVal < 1 || sVal > 30) {
    errS.textContent = 'Spacing must be between 1 and 30 ft.';
    valid = false;
  }
  if (!valid) e.preventDefault();
});

// Persist form state in sessionStorage
(function() {
  const form = document.getElementById('step2Form');
  const fields = ['height_total_ft','post_spacing_ft','fence_length_ft',
                  'fence_type','line_post_key','terminal_post_key',
                  'embedment_depth_in','footing_diameter_in','num_gates','num_corners'];
  fields.forEach(function(f) {
    const el = document.getElementById(f);
    if (!el) return;
    const saved = sessionStorage.getItem('step2_' + f);
    if (saved && !el.value) el.value = saved;
    el.addEventListener('change', function() {
      sessionStorage.setItem('step2_' + f, el.value);
    });
    el.addEventListener('input', function() {
      sessionStorage.setItem('step2_' + f, el.value);
    });
  });
})();
</script>
{% endblock %}
