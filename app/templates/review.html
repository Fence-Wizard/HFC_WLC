{% extends "base.html" %}
{% block content %}
<h2>Review & Results</h2>

<h3>Inputs</h3>
<ul>
  <li>ZIP code: {{ data.zip_code }}</li>
  <li>Risk category: {{ data.risk_category }}</li>
  <li>Wind: {{ data.wind_speed_mph }} mph</li>
  <li>Exposure: {{ data.exposure }}</li>
  <li>Height: {{ data.height_total_ft }} ft</li>
  <li>Post spacing: <strong>{{ data.post_spacing_ft }} ft</strong></li>
  {% set current_post_key = data.post_key or result.recommended.post_key or "" %}
  {% set current_post_label = post_labels.get(current_post_key) or result.recommended.post_label %}
  <li>
    Post type (current):
    {{ current_post_label or "Auto (based on load)" }}
  </li>
  <li>Soil type: {{ data.soil_type }}</li>
  <li>Job: {{ data.job_name }}</li>
</ul>

<h3>Results</h3>
<ul>
  <li>Pressure: {{ "%.2f"|format(result.pressure_psf) }} psf</li>
  <li>Area per bay: <strong>{{ "%.1f"|format(result.area_per_bay_ft2) }} ftÂ²</strong> (height Ã— spacing = {{ data.height_total_ft }} Ã— {{ data.post_spacing_ft }})</li>
  <li>Total load per bay: <strong>{{ "%.0f"|format(result.total_load_lb) }} lb</strong></li>
  <li>Load per post: <strong>{{ "%.0f"|format(result.load_per_post_lb) }} lb</strong></li>
  <li>
    Recommended post:
    {{ result.recommended.post_label or result.recommended.post_key or 'N/A' }}
  </li>
  <li>
    Footing:
    {{ result.recommended.footing_diameter_in or 'N/A' }} in dia Ã—
    {{ result.recommended.embedment_in or 'N/A' }} in deep
  </li>
</ul>

{% if result.max_spacing_ft %}
  <p>
    <strong>Max recommended spacing for this post at these conditions:</strong>
    approx {{ "%.2f"|format(result.max_spacing_ft) }} ft.
  </p>

  {% if data.post_spacing_ft > result.max_spacing_ft %}
    <p style="font-weight: bold;">
      âš  Current spacing {{ "%.2f"|format(data.post_spacing_ft) }} ft exceeds this limit.
      Consider tightening spacing or increasing post size.
    </p>
  {% endif %}
{% endif %}

<h3>Try a different spacing / post type</h3>
<form method="post" action="/review" enctype="multipart/form-data">
  <!-- Keep all existing inputs as hidden so the calculation stays tied to the same job -->
  <input type="hidden" name="zip_code" value="{{ data.zip_code }}" />
  <input type="hidden" name="risk_category" value="{{ data.risk_category }}" />
  <input type="hidden" name="wind_speed_mph" value="{{ data.wind_speed_mph }}" />
  <input type="hidden" name="exposure" value="{{ data.exposure }}" />
  <input type="hidden" name="height_total_ft" value="{{ data.height_total_ft }}" />
  <input type="hidden" name="soil_type" value="{{ data.soil_type }}" />
  <input type="hidden" name="job_name" value="{{ data.job_name }}" />
  <!-- Legacy post_size preserved for backward compatibility but not used for selection -->
  <input type="hidden" name="post_size" value="{{ data.post_size }}" />
  <input type="hidden" name="post_role" value="{{ data.post_role }}" />

  <label for="post_spacing_ft">Post spacing (ft):</label>
  <input
    type="number"
    id="post_spacing_ft"
    name="post_spacing_ft"
    step="0.1"
    min="2"
    max="20"
    value="{{ data.post_spacing_ft }}"
    required
  />

  <label for="line_post_key">Line post type:</label>
  <select id="line_post_key" name="line_post_key">
    {% set current_line_post = data.line_post_key or "" %}
    <option value="" {% if not current_line_post %}selected{% endif %}>
      Auto (based on load)
    </option>

    {% for opt in post_options %}
    <option value="{{ opt.key }}"
      {% if opt.key == current_line_post %}selected{% endif %}>
      {{ opt.label }}
    </option>
    {% endfor %}
  </select>

  <label for="terminal_post_key">Terminal post type:</label>
  <select id="terminal_post_key" name="terminal_post_key">
    {% set current_terminal_post = data.terminal_post_key or "" %}
    <option value="" {% if not current_terminal_post %}selected{% endif %}>
      Auto (based on load)
    </option>

    {% for opt in post_options %}
    <option value="{{ opt.key }}"
      {% if opt.key == current_terminal_post %}selected{% endif %}>
      {{ opt.label }}
    </option>
    {% endfor %}
  </select>

  <button type="submit">Recalculate</button>
</form>

<h3>Structural Status</h3>

<div class="status-banner status-{{ risk.lower() }}">
  {% if risk == "GREEN" %}
    <div class="status-header">
      <strong>ðŸŸ¢ GREEN â€“ Configuration is within recommended limits</strong>
    </div>
    <p>Meets preliminary structural criteria. PM can quote using this configuration.</p>
  {% elif risk == "YELLOW" %}
    <div class="status-header">
      <strong>ðŸŸ¡ YELLOW â€“ Configuration is close to a structural limit</strong>
    </div>
    <p>Adjust spacing or post size. For bid purposes, consider flagging for engineer review if client requires compliance with ASCE interpretations.</p>
  {% else %}
    <div class="status-header">
      <strong>ðŸ”´ RED â€“ Configuration exceeds structural limits</strong>
    </div>
    <p><strong>NOT acceptable</strong> â€” change post size, spacing, or seek engineering. This exceeds simplified design limits â€” revise configuration.</p>
  {% endif %}
</div>

{% if risk_details and risk_details.reasons %}
<div class="status-details">
  <h4>Status Details:</h4>
  <ul>
    {% for reason in risk_details.reasons %}
    <li>{{ reason }}</li>
    {% endfor %}
  </ul>
  
  {% if risk_details.spacing_ratio is not none and risk_details.max_spacing_ft is not none %}
  <p>
    <strong>Spacing ratio:</strong> {{ "%.1f"|format(risk_details.spacing_ratio * 100) }}% 
    ({{ "%.2f"|format(data.post_spacing_ft) }} ft / {{ "%.2f"|format(risk_details.max_spacing_ft) }} ft max)
  </p>
  {% endif %}
  
</div>
{% endif %}

{% if result.warnings %}
<h3>Warnings</h3>
<ul>
  {% for w in result.warnings %}
  <li>{{ w }}</li>
  {% endfor %}
</ul>
{% endif %}

{% if result.assumptions %}
<h3>Assumptions</h3>
<ul>
  {% for a in result.assumptions %}
  <li>{{ a }}</li>
  {% endfor %}
</ul>
{% endif %}

<h3>PDF</h3>
<a
  href="/download?zip_code={{ data.zip_code }}&risk_category={{ data.risk_category }}&wind_speed_mph={{ data.wind_speed_mph }}&exposure={{ data.exposure }}&height_total_ft={{ data.height_total_ft }}&post_spacing_ft={{ data.post_spacing_ft }}&soil_type={{ data.soil_type }}&job_name={{ data.job_name }}&post_role={{ data.post_role }}{% if data.post_key %}&post_key={{ data.post_key }}{% endif %}"
  >Download PDF report</a
>

{% endblock %}
