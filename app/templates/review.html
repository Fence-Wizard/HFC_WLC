{% extends "base.html" %}

{% block title %}Results | HFC Windload Calculator{% endblock %}

{% block progress %}
<div class="progress-bar">
  <div class="progress-bar-inner">
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Wind</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Geometry</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Job Info</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step active">
      <span class="progress-dot">4</span>
      <span>Results</span>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}

<!-- ===== Status Banner ===== -->
{% if result.overall_status == "GREEN" %}
<div class="status-banner status-green">
  <span class="status-icon" style="font-size: 1.8rem;">&#x2705;</span>
  <div class="status-body">
    <h3>Within Limits</h3>
    <p>Post spacing and structural checks are within allowable limits.</p>
  </div>
</div>
{% elif result.overall_status == "YELLOW" %}
<div class="status-banner status-yellow">
  <span class="status-icon" style="font-size: 1.8rem;">&#x26A0;&#xFE0F;</span>
  <div class="status-body">
    <h3>Marginal &mdash; Review Carefully</h3>
    <p>Near the edge of allowable limits. Consider reducing spacing or using heavier posts.</p>
  </div>
</div>
{% else %}
<div class="status-banner status-red">
  <span class="status-icon" style="font-size: 1.8rem;">&#x274C;</span>
  <div class="status-body">
    <h3>Exceeds Limits &mdash; Action Required</h3>
    <p>Reduce spacing, increase post size, or consult the project engineer.</p>
  </div>
</div>
{% endif %}

<!-- ===== Summary Tiles ===== -->
<div class="results-grid">
  <div class="result-tile">
    <div class="result-value">{{ "%.1f"|format(result.shared.pressure_psf) }}</div>
    <div class="result-label">Pressure</div>
    <div class="result-unit">psf</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.0f"|format(result.shared.total_load_lb) }}</div>
    <div class="result-label">Bay Load</div>
    <div class="result-unit">lb</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.0f"|format(result.shared.load_per_post_lb) }}</div>
    <div class="result-label">Per Post</div>
    <div class="result-unit">lb</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.1f"|format(result.shared.area_per_bay_ft2) }}</div>
    <div class="result-label">Bay Area</div>
    <div class="result-unit">ft&sup2;</div>
  </div>
</div>

<!-- ===== Post Recommendations ===== -->
{# Macro to render a utilization bar with CSS classes instead of inline colors #}
{% macro util_bar(label, ratio) %}
{% set pct = (ratio * 100)|int %}
{% set cls = 'fail' if pct > 100 else ('warn' if pct > 85 else 'ok') %}
<div class="utilization-bar-wrap">
  <div class="utilization-label">{{ label }}</div>
  <div class="utilization-bar">
    <div class="utilization-fill fill-{{ cls }}" style="width: {{ [pct, 100]|min }}%;"></div>
  </div>
  <div class="utilization-pct color-{{ cls }}">{{ pct }}%</div>
</div>
{% endmacro %}

<div class="card">
  <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0.5rem;">
    <h2>Post Recommendations</h2>
    {% if data.project_name %}
    <p>{{ data.project_name }}{% if data.location %} &mdash; {{ data.location }}{% endif %}</p>
    {% endif %}
  </div>

  <div class="post-cards-grid">
    <!-- Line Post -->
    <div class="post-card">
      <div class="post-card-header post-card-line">
        <span class="post-card-tag">Line Post</span>
        {% if result.line.status == "GREEN" %}
        <span class="post-card-status post-card-ok">OK</span>
        {% elif result.line.status == "YELLOW" %}
        <span class="post-card-status post-card-marginal">Marginal</span>
        {% else %}
        <span class="post-card-status post-card-fail">Over</span>
        {% endif %}
      </div>
      <div class="post-card-body">
        <div class="post-card-size">{{ result.line.recommended.post_label or "Auto" }}</div>
        <div class="post-card-detail">
          {% if result.line.max_spacing_ft %}
          <span>Max spacing: <b>{{ "%.1f"|format(result.line.max_spacing_ft) }} ft</b></span>
          {% endif %}
        </div>
        {% if result.line.spacing_ratio is not none %}
        {{ util_bar("Spacing", result.line.spacing_ratio) }}
        {% endif %}
        {% if result.line.moment_ratio is not none %}
        {{ util_bar("Bending", result.line.moment_ratio) }}
        {% endif %}
        <div class="post-card-footing">
          {{ result.line.recommended.footing_diameter_in|int }}" dia &times; {{ result.line.recommended.embedment_in|int }}" deep
        </div>
      </div>
    </div>

    <!-- Terminal Post -->
    <div class="post-card">
      <div class="post-card-header post-card-terminal">
        <span class="post-card-tag">Terminal Post</span>
        {% if result.terminal.status == "GREEN" %}
        <span class="post-card-status post-card-ok">OK</span>
        {% elif result.terminal.status == "YELLOW" %}
        <span class="post-card-status post-card-marginal">Marginal</span>
        {% else %}
        <span class="post-card-status post-card-fail">Over</span>
        {% endif %}
      </div>
      <div class="post-card-body">
        <div class="post-card-size">{{ result.terminal.recommended.post_label or "Auto" }}</div>
        <div class="post-card-detail">
          {% if result.terminal.max_spacing_ft %}
          <span>Max spacing: <b>{{ "%.1f"|format(result.terminal.max_spacing_ft) }} ft</b></span>
          {% endif %}
        </div>
        {% if result.terminal.spacing_ratio is not none %}
        {{ util_bar("Spacing", result.terminal.spacing_ratio) }}
        {% endif %}
        {% if result.terminal.moment_ratio is not none %}
        {{ util_bar("Bending", result.terminal.moment_ratio) }}
        {% endif %}
        <div class="post-card-footing">
          {{ result.terminal.recommended.footing_diameter_in|int }}" dia &times; {{ result.terminal.recommended.embedment_in|int }}" deep
        </div>
      </div>
    </div>
  </div>

  <!-- Warnings -->
  {% set all_warnings = result.line.warnings + result.terminal.warnings %}
  {% if all_warnings %}
  <div style="margin-top: 1rem;">
    {% for w in all_warnings|unique %}
    <div class="inline-warning">{{ w }}</div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- ===== Quantities ===== -->
{% if result.quantities %}
<div class="card">
  <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0.5rem;">
    <h2>Material Takeoff</h2>
    <p>{{ "%.0f"|format(result.quantities.fence_length_ft) }} LF fence run</p>
  </div>
  <div class="qty-grid">
    <div class="qty-item">
      <div class="qty-val">{{ result.quantities.total_posts }}</div>
      <div class="qty-lbl">Total Posts</div>
    </div>
    <div class="qty-item">
      <div class="qty-val">{{ "%.0f"|format(result.quantities.top_rail_lf) }}</div>
      <div class="qty-lbl">Top Rail (LF)</div>
    </div>
    <div class="qty-item">
      <div class="qty-val">{{ "%.0f"|format(result.quantities.fabric_sf) }}</div>
      <div class="qty-lbl">Fabric (SF)</div>
    </div>
    <div class="qty-item">
      <div class="qty-val">{{ "%.1f"|format(result.quantities.total_concrete_cy) }}</div>
      <div class="qty-lbl">Concrete (CY)</div>
    </div>
  </div>
  <div class="qty-detail text-muted text-sm" style="margin-top: 0.75rem;">
    {{ result.quantities.num_line_posts }} line
    + {{ result.quantities.num_terminal_posts }} terminal
    {% if result.quantities.num_corner_posts %} + {{ result.quantities.num_corner_posts }} corner{% endif %}
    {% if result.quantities.num_gate_posts %} + {{ result.quantities.num_gate_posts }} gate{% endif %}
  </div>
</div>
{% endif %}

<!-- ===== Download ===== -->
<div class="card" style="text-align: center;">
  <a
    class="btn btn-primary btn-lg"
    href="/download?zip_code={{ data.zip_code }}&risk_category={{ data.risk_category }}&wind_speed_mph={{ data.wind_speed_mph }}&exposure={{ data.exposure }}&height_total_ft={{ data.height_total_ft }}&post_spacing_ft={{ data.post_spacing_ft }}&fence_length_ft={{ data.fence_length_ft or '' }}&job_name={{ data.project_name or data.job_name or 'Job' }}&project_name={{ data.project_name or '' }}&location={{ data.location or '' }}&estimator={{ data.estimator or '' }}&soil_type={{ data.soil_type or 'default' }}&fence_type={{ data.fence_type or 'chain_link_open' }}&line_post_key={{ data.line_post_key or '' }}&terminal_post_key={{ data.terminal_post_key or '' }}&kzt={{ data.kzt or '1.0' }}"
    style="margin-bottom: 0.75rem;"
  >
    Download PDF Report
  </a>
  <p class="text-muted text-sm" style="margin: 0;">Detailed ASCE 7-22 report for your project file.</p>
</div>

<!-- ===== What-If ===== -->
<div class="card">
  <details>
    <summary>Quick What-If</summary>
    <div class="detail-content" style="margin-top: 0.75rem;">
      <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 180px;">
          <label class="text-sm" style="font-weight: 600;">Spacing: <span id="whatif_spacing_val">{{ data.post_spacing_ft }}</span> ft</label>
          <input type="range" id="whatif_spacing" min="4" max="20" step="0.5"
                 value="{{ data.post_spacing_ft }}" style="width: 100%;"
                 oninput="document.getElementById('whatif_spacing_val').textContent = this.value; runWhatIf();" />
        </div>
        <div style="flex: 1; min-width: 180px;">
          <label class="text-sm" style="font-weight: 600;">Height: <span id="whatif_height_val">{{ data.height_total_ft }}</span> ft</label>
          <input type="range" id="whatif_height" min="4" max="20" step="0.5"
                 value="{{ data.height_total_ft }}" style="width: 100%;"
                 oninput="document.getElementById('whatif_height_val').textContent = this.value; runWhatIf();" />
        </div>
      </div>
      <div id="whatif_result" style="margin-top: 0.6rem; padding: 0.6rem 0.75rem; background: var(--hfc-surface); border-radius: 6px; display: none; font-size: 0.9rem;">
        <span id="wi_pressure">-</span> psf &nbsp;|&nbsp;
        <b id="wi_status" style="font-weight: 700;">-</b> &nbsp;|&nbsp;
        Bay: <span id="wi_load">-</span> lb &nbsp;|&nbsp;
        Post: <span id="wi_perpost">-</span> lb
      </div>
    </div>
  </details>
</div>

<!-- ===== Engineering Details ===== -->
<div class="card">
  <details>
    <summary>Engineering Details</summary>
    <div class="detail-content" style="margin-top: 0.75rem;">

      <h4 style="margin: 0.5rem 0; font-size: 0.88rem;">Input Parameters</h4>
      <table class="data-table" style="font-size: 0.85rem;">
        <tr><td>Wind Speed</td><td>{{ data.wind_speed_mph }} mph</td></tr>
        <tr><td>Exposure</td><td>{{ data.exposure }}</td></tr>
        <tr><td>Risk Category</td><td>{{ data.risk_category }}</td></tr>
        <tr><td>Fence Height</td><td>{{ data.height_total_ft }} ft</td></tr>
        <tr><td>Post Spacing</td><td>{{ data.post_spacing_ft }} ft</td></tr>
        <tr><td>Fence Type</td><td>{{ data.fence_type | replace("_", " ") | title }}</td></tr>
        {% if data.fence_length_ft %}
        <tr><td>Run Length</td>
          <td>{{ data.fence_length_ft }} ft
            (B/s = {{ "%.1f"|format(data.fence_length_ft|float / data.height_total_ft|float) }})
          </td>
        </tr>
        {% endif %}
        {% if data.estimator %}<tr><td>Estimator</td><td>{{ data.estimator }}</td></tr>{% endif %}
      </table>

      {% if result.shared.design_params %}
      {% set dp = result.shared.design_params %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">ASCE 7-22 Calculation</h4>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-surface); padding: 0.4rem 0.6rem; border-radius: 4px; margin-bottom: 0.4rem;">
        q<sub>z</sub> = 0.00256 &times; {{ "%.3f"|format(dp.kz) }}
        &times; {{ dp.kzt }} &times; {{ dp.kd }}
        &times; {{ data.wind_speed_mph }}&sup2;
        = <b>{{ "%.2f"|format(dp.qz_psf) }} psf</b>
      </p>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-surface); padding: 0.4rem 0.6rem; border-radius: 4px;">
        p = {{ "%.2f"|format(dp.qz_psf) }} &times; {{ dp.g }}
        &times; {{ "%.3f"|format(dp.cf) }}
        = <b>{{ "%.2f"|format(result.shared.pressure_psf) }} psf</b>
      </p>
      <table class="data-table" style="font-size: 0.82rem; margin-top: 0.5rem;">
        <tr><td>K<sub>z</sub></td><td>{{ "%.4f"|format(dp.kz) }}</td></tr>
        <tr><td>K<sub>zt</sub></td><td>{{ dp.kzt }}</td></tr>
        <tr><td>K<sub>d</sub></td><td>{{ dp.kd }}</td></tr>
        <tr><td>G</td><td>{{ dp.g }}</td></tr>
        <tr><td>C<sub>f,solid</sub></td><td>{{ "%.3f"|format(dp.cf_solid) }}</td></tr>
        <tr><td>Solidity &epsilon;</td><td>{{ "%.2f"|format(dp.solidity) }}</td></tr>
        <tr><td>C<sub>f</sub></td><td>{{ "%.3f"|format(dp.cf) }}</td></tr>
      </table>
      {% endif %}

      {% for rname, blk in [("Line", result.line), ("Terminal", result.terminal)] %}
      {% if blk.M_demand_ft_lb and blk.M_allow_ft_lb %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">{{ rname }} Bending Check</h4>
      <table class="data-table" style="font-size: 0.82rem;">
        <tr><td>M<sub>demand</sub></td><td>{{ "%.1f"|format(blk.M_demand_ft_lb) }} ft-lb</td></tr>
        <tr><td>M<sub>allow</sub></td><td>{{ "%.1f"|format(blk.M_allow_ft_lb) }} ft-lb</td></tr>
        <tr><td>Utilization</td><td>{{ "%.0f"|format(blk.M_demand_ft_lb / blk.M_allow_ft_lb * 100) }}%</td></tr>
      </table>
      {% endif %}
      {% endfor %}

      {% for rname, blk in [("Line", result.line), ("Terminal", result.terminal)] %}
      {% if blk.footing %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">{{ rname }} Footing (IBC 1807.3)</h4>
      <table class="data-table" style="font-size: 0.82rem;">
        <tr><td>Soil</td><td>{{ blk.footing.soil_label }}</td></tr>
        <tr><td>Embedment</td><td>{{ "%.1f"|format(blk.footing.actual_embedment_ft) }} ft</td></tr>
        <tr><td>Min Required</td><td>{{ "%.1f"|format(blk.footing.min_embedment_ft) }} ft</td></tr>
        <tr><td>Safety Factor</td>
          <td>
            <span class="utilization-{{ 'red' if blk.footing.safety_factor < 1.5 else ('yellow' if blk.footing.safety_factor < 2.0 else 'green') }}">
              {{ "%.2f"|format(blk.footing.safety_factor) }}
            </span>
            (need &ge; 1.50)
          </td>
        </tr>
      </table>
      {% endif %}
      {% endfor %}

      {% for rname, blk in [("Line", result.line), ("Terminal", result.terminal)] %}
      {% if blk.deflection and blk.deflection.deflection_in > 0 %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">{{ rname }} Deflection (L/60)</h4>
      <table class="data-table" style="font-size: 0.82rem;">
        <tr><td>Deflection</td><td>{{ "%.3f"|format(blk.deflection.deflection_in) }}"</td></tr>
        <tr><td>Allowable</td><td>{{ "%.3f"|format(blk.deflection.allowable_in) }}"</td></tr>
        <tr><td>Utilization</td>
          <td>
            <span class="utilization-{{ 'red' if not blk.deflection.deflection_ok else 'green' }}">
              {{ "%.0f"|format(blk.deflection.ratio * 100) }}%
            </span>
          </td>
        </tr>
      </table>
      {% endif %}
      {% endfor %}

      {% if result.line.assumptions %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">Assumptions</h4>
      <ul style="font-size: 0.82rem; padding-left: 1rem;">
        {% for a in result.line.assumptions %}
        <li style="margin-bottom: 0.3rem;">{{ a }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </details>
</div>

<!-- ===== Saved Scenarios ===== -->
<div class="card">
  <details>
    <summary>Save &amp; Compare Scenarios</summary>
    <div class="detail-content" style="margin-top: 0.75rem;">
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
        <input type="text" id="scenario_name" placeholder="Scenario name"
               style="flex: 1; padding: 0.35rem 0.5rem; font-size: 0.88rem;" />
        <button type="button" class="btn btn-primary" style="padding: 0.35rem 0.75rem; font-size: 0.88rem;" onclick="saveScenario()">Save</button>
      </div>
      <div id="saved_scenarios_list" style="font-size: 0.85rem;"></div>
    </div>
  </details>
</div>

<!-- ===== Start Over ===== -->
<div class="text-center mt-2" style="margin-bottom: 1rem;">
  <a href="/" class="btn btn-secondary">Start New Estimate</a>
</div>

<script>
function _themeColor(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
var _wiTimer = null;
function runWhatIf() {
  clearTimeout(_wiTimer);
  _wiTimer = setTimeout(function() {
    var s = document.getElementById('whatif_spacing').value;
    var h = document.getElementById('whatif_height').value;
    var body = {
      wind_speed_mph: {{ data.wind_speed_mph }},
      height_total_ft: parseFloat(h),
      post_spacing_ft: parseFloat(s),
      exposure: "{{ data.exposure }}",
      fence_type: "{{ data.fence_type or 'chain_link_open' }}",
      risk_category: "{{ data.risk_category }}",
      kzt: {{ data.kzt or 1.0 }}
    };
    var lk = "{{ data.line_post_key or '' }}";
    var tk = "{{ data.terminal_post_key or '' }}";
    if (lk && lk !== 'auto') body.line_post_key = lk;
    if (tk && tk !== 'auto') body.terminal_post_key = tk;
    fetch('/api/v1/estimate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
    .then(function(r){return r.json();})
    .then(function(d){
      document.getElementById('whatif_result').style.display='block';
      document.getElementById('wi_pressure').textContent=d.shared.pressure_psf.toFixed(1);
      document.getElementById('wi_load').textContent=d.shared.total_load_lb.toFixed(0);
      document.getElementById('wi_perpost').textContent=d.shared.load_per_post_lb.toFixed(0);
      var st=d.overall_status, el=document.getElementById('wi_status');
      el.textContent=st;
      el.style.color = st==='GREEN' ? _themeColor('--hfc-ok') : (st==='YELLOW' ? _themeColor('--hfc-warn') : _themeColor('--hfc-fail'));
    }).catch(function(){});
  }, 300);
}
function saveScenario(){
  var n=document.getElementById('scenario_name').value.trim();
  if(!n){alert('Enter a name.');return;}
  var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]');
  sc.push({name:n,ts:new Date().toISOString(),d:{
    ws:{{ data.wind_speed_mph }},h:{{ data.height_total_ft }},s:{{ data.post_spacing_ft }},
    exp:"{{ data.exposure }}",p:{{ "%.2f"|format(result.shared.pressure_psf) }},
    st:"{{ result.overall_status }}",lp:"{{ result.line.recommended.post_label or 'Auto' }}",
    tp:"{{ result.terminal.recommended.post_label or 'Auto' }}"
  }});
  localStorage.setItem('wlc_scenarios',JSON.stringify(sc));
  document.getElementById('scenario_name').value='';
  renderSc();
}
function delSc(i){var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]');sc.splice(i,1);localStorage.setItem('wlc_scenarios',JSON.stringify(sc));renderSc();}
function renderSc(){
  var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]'),el=document.getElementById('saved_scenarios_list');
  if(!sc.length){el.innerHTML='<p class="text-muted" style="font-size:0.82rem;">No saved scenarios.</p>';return;}
  var h='<table class="data-table" style="font-size:0.82rem;"><tr><th style="text-align:left;">Name</th><th>Wind</th><th>Height</th><th>Pressure</th><th>Status</th><th></th></tr>';
  sc.forEach(function(s,i){
    var cls=s.d.st==='GREEN'?'color-ok':(s.d.st==='YELLOW'?'color-warn':'color-fail');
    h+='<tr><td style="text-align:left;">'+s.name+'</td><td>'+s.d.ws+'</td><td>'+s.d.h+'</td><td>'+s.d.p+'</td><td class="'+cls+'" style="font-weight:600;">'+s.d.st+'</td><td><button onclick="delSc('+i+')" style="border:none;background:none;color:var(--hfc-red);cursor:pointer;">&times;</button></td></tr>';
  });
  el.innerHTML=h+'</table>';
}
renderSc();
</script>

{% endblock %}
