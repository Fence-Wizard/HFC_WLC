{% extends "base.html" %}

{% block title %}Results | HFC Windload Calculator{% endblock %}

{% block progress %}
<div class="progress-bar">
  <div class="progress-bar-inner">
    <div class="progress-step completed"><span class="progress-dot">&#10003;</span><span>Wind</span></div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed"><span class="progress-dot">&#10003;</span><span>Geometry</span></div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed"><span class="progress-dot">&#10003;</span><span>Job Info</span></div>
    <div class="progress-connector completed"></div>
    <div class="progress-step active"><span class="progress-dot">4</span><span>Results</span></div>
  </div>
</div>
{% endblock %}

{% block content %}

<!-- Status Banner -->
<div id="status-banner"></div>

<!-- Summary Tiles -->
<div class="results-grid" id="summary-tiles"></div>

<!-- ===== Configuration + Results ===== -->
<div class="card">
  <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0.5rem;">
    <h2>Post Recommendations</h2>
    {% if data.project_name %}
    <p>{{ data.project_name }}{% if data.location %} &mdash; {{ data.location }}{% endif %}</p>
    {% endif %}
  </div>

  <!-- Tinker controls -->
  <div class="tinker-grid">
    <div class="tinker-item">
      <label>Line Post</label>
      <select id="sel_line_post" onchange="liveCalc()">
        <option value="auto">Auto (recommended)</option>
        {% for g_label, g_keys in [
          ("SS20 (Sch 20, Fy=30 ksi)", ["1_5_8_SS20","1_7_8_SS20","2_3_8_SS20","2_7_8_SS20","3_1_2_SS20","4_0_SS20"]),
          ("SS40 (Sch 40, Fy=50 ksi)", ["1_7_8_PIPE","2_3_8_SS40","2_7_8_SS40","3_1_2_SS40","4_0_PIPE","6_5_8_PIPE","8_5_8_PIPE"]),
          ("Sch 80 (Fy=50 ksi)", ["2_3_8_S80","2_7_8_S80","3_1_2_S80","4_0_S80"])
        ] %}
        <optgroup label="{{ g_label }}">
          {% for pk in g_keys %}{% if pk in post_labels %}
          <option value="{{ pk }}" {% if data.line_post_key == pk or result.line.recommended.post_key == pk %}selected{% endif %}>{{ post_labels[pk] }}</option>
          {% endif %}{% endfor %}
        </optgroup>
        {% endfor %}
      </select>
    </div>
    <div class="tinker-item">
      <label>Terminal Post</label>
      <select id="sel_term_post" onchange="liveCalc()">
        <option value="auto">Auto (recommended)</option>
        {% for g_label, g_keys in [
          ("SS20 (Sch 20, Fy=30 ksi)", ["1_5_8_SS20","1_7_8_SS20","2_3_8_SS20","2_7_8_SS20","3_1_2_SS20","4_0_SS20"]),
          ("SS40 (Sch 40, Fy=50 ksi)", ["1_7_8_PIPE","2_3_8_SS40","2_7_8_SS40","3_1_2_SS40","4_0_PIPE","6_5_8_PIPE","8_5_8_PIPE"]),
          ("Sch 80 (Fy=50 ksi)", ["2_3_8_S80","2_7_8_S80","3_1_2_S80","4_0_S80"])
        ] %}
        <optgroup label="{{ g_label }}">
          {% for pk in g_keys %}{% if pk in post_labels %}
          <option value="{{ pk }}" {% if data.terminal_post_key == pk or result.terminal.recommended.post_key == pk %}selected{% endif %}>{{ post_labels[pk] }}</option>
          {% endif %}{% endfor %}
        </optgroup>
        {% endfor %}
      </select>
    </div>
    <div class="tinker-item">
      <label>Spacing: <b id="lbl_spacing">{{ data.post_spacing_ft }}</b> ft</label>
      <input type="range" id="rng_spacing" min="4" max="20" step="0.5"
             value="{{ data.post_spacing_ft }}"
             oninput="document.getElementById('lbl_spacing').textContent=this.value; liveCalc();" />
    </div>
    <div class="tinker-item">
      <label>Height: <b id="lbl_height">{{ data.height_total_ft }}</b> ft</label>
      <input type="range" id="rng_height" min="4" max="20" step="0.5"
             value="{{ data.height_total_ft }}"
             oninput="document.getElementById('lbl_height').textContent=this.value; liveCalc();" />
    </div>
  </div>

  <!-- Post result cards (built by JS) -->
  <div class="post-cards-grid" id="post-cards"></div>

  <!-- Warnings -->
  <div id="post-warnings" style="margin-top: 0.75rem;"></div>
</div>

<!-- ===== Spec Drawing (JS-rendered) ===== -->
<div class="card">
  <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0.25rem;">
    <h2>Post &amp; Footing Detail</h2>
  </div>
  <div id="spec-drawing" style="display: flex; justify-content: center; padding: 0;"></div>
</div>

<!-- ===== Quantities ===== -->
{% if result.quantities %}
<div class="card">
  <div class="card-header" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0.5rem;">
    <h2>Material Takeoff</h2>
    <p>{{ "%.0f"|format(result.quantities.fence_length_ft) }} LF fence run</p>
  </div>
  <div class="qty-grid">
    <div class="qty-item"><div class="qty-val">{{ result.quantities.total_posts }}</div><div class="qty-lbl">Total Posts</div></div>
    <div class="qty-item"><div class="qty-val">{{ "%.0f"|format(result.quantities.top_rail_lf) }}</div><div class="qty-lbl">Top Rail (LF)</div></div>
    <div class="qty-item"><div class="qty-val">{{ "%.0f"|format(result.quantities.fabric_sf) }}</div><div class="qty-lbl">Fabric (SF)</div></div>
    <div class="qty-item"><div class="qty-val">{{ "%.1f"|format(result.quantities.total_concrete_cy) }}</div><div class="qty-lbl">Concrete (CY)</div></div>
  </div>
</div>
{% endif %}

<!-- Download -->
<div class="card" style="text-align: center;">
  <a class="btn btn-primary btn-lg" id="pdf-link"
    href="/download?zip_code={{ data.zip_code }}&risk_category={{ data.risk_category }}&wind_speed_mph={{ data.wind_speed_mph }}&exposure={{ data.exposure }}&height_total_ft={{ data.height_total_ft }}&post_spacing_ft={{ data.post_spacing_ft }}&fence_length_ft={{ data.fence_length_ft or '' }}&job_name={{ data.project_name or data.job_name or 'Job' }}&project_name={{ data.project_name or '' }}&location={{ data.location or '' }}&estimator={{ data.estimator or '' }}&soil_type={{ data.soil_type or 'default' }}&fence_type={{ data.fence_type or 'chain_link_open' }}&line_post_key={{ data.line_post_key or '' }}&terminal_post_key={{ data.terminal_post_key or '' }}&kzt={{ data.kzt or '1.0' }}"
    style="margin-bottom: 0.75rem;">Download PDF Report</a>
  <p class="text-muted text-sm" style="margin: 0;">Detailed ASCE 7-22 report for your project file.</p>
</div>

<!-- Engineering Details -->
<div class="card">
  <details>
    <summary>Engineering Details</summary>
    <div class="detail-content" style="margin-top: 0.75rem;">
      <h4 style="margin: 0.5rem 0; font-size: 0.88rem;">Input Parameters</h4>
      <table class="data-table" style="font-size: 0.85rem;">
        <tr><td>Wind Speed</td><td>{{ data.wind_speed_mph }} mph</td></tr>
        <tr><td>Exposure</td><td>{{ data.exposure }}</td></tr>
        <tr><td>Risk Category</td><td>{{ data.risk_category }}</td></tr>
        <tr><td>Fence Height</td><td>{{ data.height_total_ft }} ft</td></tr>
        <tr><td>Post Spacing</td><td>{{ data.post_spacing_ft }} ft</td></tr>
        <tr><td>Fence Type</td><td>{{ data.fence_type | replace("_", " ") | title }}</td></tr>
        {% if data.fence_length_ft %}
        <tr><td>Run Length</td><td>{{ data.fence_length_ft }} ft (B/s = {{ "%.1f"|format(data.fence_length_ft|float / data.height_total_ft|float) }})</td></tr>
        {% endif %}
        {% if data.estimator %}<tr><td>Estimator</td><td>{{ data.estimator }}</td></tr>{% endif %}
      </table>
      {% if result.shared.design_params %}
      {% set dp = result.shared.design_params %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">ASCE 7-22 Calculation</h4>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-surface); padding: 0.4rem 0.6rem; border-radius: 4px; margin-bottom: 0.4rem;">
        q<sub>z</sub> = 0.00256 &times; {{ "%.3f"|format(dp.kz) }} &times; {{ dp.kzt }} &times; {{ dp.kd }} &times; {{ data.wind_speed_mph }}&sup2; = <b>{{ "%.2f"|format(dp.qz_psf) }} psf</b></p>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-surface); padding: 0.4rem 0.6rem; border-radius: 4px;">
        p = {{ "%.2f"|format(dp.qz_psf) }} &times; {{ dp.g }} &times; {{ "%.3f"|format(dp.cf) }} = <b>{{ "%.2f"|format(result.shared.pressure_psf) }} psf</b></p>
      {% endif %}
      {% if result.line.assumptions %}
      <h4 style="margin: 1rem 0 0.5rem; font-size: 0.88rem;">Assumptions</h4>
      <ul style="font-size: 0.82rem; padding-left: 1rem;">
        {% for a in result.line.assumptions %}<li style="margin-bottom: 0.3rem;">{{ a }}</li>{% endfor %}
      </ul>
      {% endif %}
    </div>
  </details>
</div>

<!-- Saved Scenarios -->
<div class="card">
  <details>
    <summary>Save &amp; Compare Scenarios</summary>
    <div class="detail-content" style="margin-top: 0.75rem;">
      <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
        <input type="text" id="scenario_name" placeholder="Scenario name" style="flex: 1; padding: 0.35rem 0.5rem; font-size: 0.88rem;" />
        <button type="button" class="btn btn-primary" style="padding: 0.35rem 0.75rem; font-size: 0.88rem;" onclick="saveScenario()">Save</button>
      </div>
      <div id="saved_scenarios_list" style="font-size: 0.85rem;"></div>
    </div>
  </details>
</div>

<div class="text-center mt-2" style="margin-bottom: 1rem;">
  <a href="/" class="btn btn-secondary">Start New Estimate</a>
</div>

<script>
/* ── Initial data from server ─────────────────────────────── */
var _baseData = {
  wind_speed_mph: {{ data.wind_speed_mph }},
  height_total_ft: {{ data.height_total_ft }},
  post_spacing_ft: {{ data.post_spacing_ft }},
  exposure: "{{ data.exposure }}",
  fence_type: "{{ data.fence_type or 'chain_link_open' }}",
  risk_category: "{{ data.risk_category }}",
  kzt: {{ data.kzt or 1.0 }}
  {% if data.fence_length_ft %}, fence_length_ft: {{ data.fence_length_ft }}{% endif %}
};
var _lastResult = {{ result_json | tojson }};

function _tc(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

/* ── Render everything from a result object ───────────────── */
function renderAll(d) {
  _lastResult = d;
  renderBanner(d.overall_status);
  renderTiles(d.shared);
  renderPostCard('line', d.line);
  renderPostCard('term', d.terminal);
  renderWarnings(d.line.warnings, d.terminal.warnings);
  renderSpec(d);
}

function renderBanner(st) {
  var el = document.getElementById('status-banner');
  var m = {
    GREEN: {cls:'status-green', icon:'\u2705', title:'Within Limits', desc:'Post spacing and structural checks are within allowable limits.'},
    YELLOW:{cls:'status-yellow',icon:'\u26A0\uFE0F',title:'Marginal \u2014 Review Carefully',desc:'Near the edge of allowable limits. Consider reducing spacing or using heavier posts.'},
    RED:   {cls:'status-red',   icon:'\u274C',      title:'Exceeds Limits \u2014 Action Required',desc:'Reduce spacing, increase post size, or consult the project engineer.'}
  };
  var c = m[st] || m.RED;
  el.innerHTML = '<div class="status-banner '+c.cls+'"><span class="status-icon" style="font-size:1.8rem;">'+c.icon+'</span><div class="status-body"><h3>'+c.title+'</h3><p>'+c.desc+'</p></div></div>';
}

function renderTiles(s) {
  document.getElementById('summary-tiles').innerHTML =
    tile(s.pressure_psf.toFixed(1),'Pressure','psf') +
    tile(s.total_load_lb.toFixed(0),'Bay Load','lb') +
    tile(s.load_per_post_lb.toFixed(0),'Per Post','lb') +
    tile(s.area_per_bay_ft2.toFixed(1),'Bay Area','ft\u00B2');
}
function tile(v,l,u){return '<div class="result-tile"><div class="result-value">'+v+'</div><div class="result-label">'+l+'</div><div class="result-unit">'+u+'</div></div>';}

function renderPostCard(prefix, blk) {
  var isLine = prefix === 'line';
  var hdrCls = isLine ? 'post-card-line' : 'post-card-terminal';
  var tag = isLine ? 'LINE POST' : 'TERMINAL POST';
  var badgeCls = blk.status==='GREEN'?'post-card-ok':(blk.status==='YELLOW'?'post-card-marginal':'post-card-fail');
  var badgeTxt = blk.status==='GREEN'?'OK':(blk.status==='YELLOW'?'Marginal':'Over');

  var h = '<div class="post-card"><div class="post-card-header '+hdrCls+'">'
    + '<span class="post-card-tag">'+tag+'</span>'
    + '<span class="post-card-status '+badgeCls+'">'+badgeTxt+'</span></div>'
    + '<div class="post-card-body">'
    + '<div class="post-card-size">'+(blk.recommended.post_label||'Auto')+'</div>'
    + '<div class="post-card-detail">Max spacing: <b>'+(blk.max_spacing_ft?blk.max_spacing_ft.toFixed(1):'--')+' ft</b></div>';

  if (blk.spacing_ratio != null) h += utilBar('Spacing', blk.spacing_ratio);
  if (blk.moment_ratio != null) h += utilBar('Bending', blk.moment_ratio);

  if (blk.recommended.footing_diameter_in)
    h += '<div class="post-card-footing">'+Math.round(blk.recommended.footing_diameter_in)+'" dia \u00D7 '+Math.round(blk.recommended.embedment_in)+'" deep</div>';

  h += '</div></div>';

  var container = document.getElementById('post-cards');
  if (!container._cards) container._cards = {};
  container._cards[prefix] = h;
  container.innerHTML = (container._cards['line']||'') + (container._cards['term']||'');
}

function utilBar(label, ratio) {
  var pct = Math.round(ratio * 100);
  var cls = pct > 100 ? 'fail' : (pct > 85 ? 'warn' : 'ok');
  return '<div class="utilization-bar-wrap">'
    + '<div class="utilization-label">'+label+'</div>'
    + '<div class="utilization-bar"><div class="utilization-fill fill-'+cls+'" style="width:'+Math.min(pct,100)+'%;"></div></div>'
    + '<div class="utilization-pct color-'+cls+'">'+pct+'%</div></div>';
}

function renderWarnings(lw, tw) {
  var all = (lw||[]).concat(tw||[]);
  var unique = all.filter(function(v,i,a){return a.indexOf(v)===i;});
  var el = document.getElementById('post-warnings');
  el.innerHTML = unique.map(function(w){return '<div class="inline-warning">'+w+'</div>';}).join('');
}

/* ── Spec Drawing (JS-rendered SVG) ─────────────────────────  */
function renderSpec(d) {
  var el = document.getElementById('spec-drawing');
  var hFt = parseFloat(document.getElementById('rng_height').value);
  var sFt = parseFloat(document.getElementById('rng_spacing').value);
  var rec = d.terminal.recommended;
  var embedIn = rec.embedment_in || 30;
  var ftgDia = rec.footing_diameter_in || 12;
  var postLabel = rec.post_label || 'Post';
  var postOD = rec.od_in || 2.875;

  var W = 440, H = 460;
  var gradeY = 210;
  var aboveH = Math.min(hFt * 22, 175);
  var belowH = Math.min((embedIn / 12) * 22, 155);
  var ftgW = Math.min(ftgDia * 3.2, 110);
  var postW = Math.min(postOD * 4, 22);
  var cx = 160;

  var svg = '<svg viewBox="0 0 '+W+' '+H+'" width="'+W+'" height="'+H+'" xmlns="http://www.w3.org/2000/svg" style="font-family:Inter,sans-serif;max-width:100%;">';

  // Defs
  svg += '<defs>'
    + '<pattern id="sh" patternUnits="userSpaceOnUse" width="6" height="6" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="6" stroke="var(--hfc-text-tertiary)" stroke-width="0.5" opacity="0.3"/></pattern>'
    + '<pattern id="cd" patternUnits="userSpaceOnUse" width="5" height="5"><circle cx="1.2" cy="1.2" r="0.6" fill="var(--hfc-text-tertiary)" opacity="0.4"/><circle cx="3.8" cy="3.8" r="0.6" fill="var(--hfc-text-tertiary)" opacity="0.4"/></pattern>'
    + '</defs>';

  // Soil hatching background
  svg += '<rect x="20" y="'+gradeY+'" width="'+(W-40)+'" height="'+(belowH+40)+'" fill="url(#sh)"/>';

  // Concrete pier
  var ftgL = cx - ftgW/2, ftgR = cx + ftgW/2;
  svg += '<rect x="'+ftgL+'" y="'+gradeY+'" width="'+ftgW+'" height="'+belowH+'" fill="url(#cd)" stroke="var(--hfc-text-secondary)" stroke-width="1.2" rx="2"/>';
  svg += '<rect x="'+ftgL+'" y="'+gradeY+'" width="'+ftgW+'" height="'+belowH+'" fill="var(--hfc-text-tertiary)" opacity="0.08" rx="2"/>';

  // Post (full length)
  var postTop = gradeY - aboveH;
  var postL = cx - postW/2;
  svg += '<rect x="'+postL+'" y="'+postTop+'" width="'+postW+'" height="'+(aboveH+belowH)+'" fill="var(--hfc-blue)" stroke="var(--hfc-blue-dark)" stroke-width="1" rx="1.5"/>';

  // Post cap
  svg += '<rect x="'+(postL-2)+'" y="'+(postTop-3)+'" width="'+(postW+4)+'" height="4" fill="var(--hfc-blue-dark)" rx="1.5"/>';

  // Top rail
  var railL = postL - 4, railR = cx + postW/2 + 120;
  var railY = postTop + 6;
  svg += '<rect x="'+railL+'" y="'+railY+'" width="'+(railR-railL)+'" height="4" fill="var(--hfc-blue)" stroke="var(--hfc-blue-dark)" stroke-width="0.6" rx="2"/>';
  svg += '<text x="'+(railR+4)+'" y="'+(railY+3.5)+'" font-size="8" fill="var(--hfc-text-tertiary)" font-weight="500">TOP RAIL</text>';

  // Fence fabric - diamond mesh pattern
  var fabL = cx + postW/2 + 3, fabW = 115;
  var fabT = railY + 6, fabH = aboveH - 16;
  svg += '<rect x="'+fabL+'" y="'+fabT+'" width="'+fabW+'" height="'+fabH+'" fill="none" stroke="var(--hfc-text-tertiary)" stroke-width="0.8" rx="1"/>';
  // Diamond mesh lines
  var meshStep = 12;
  for (var i = 0; i <= fabW + fabH; i += meshStep) {
    var x1 = fabL + Math.max(0, i - fabH), y1 = fabT + Math.min(i, fabH);
    var x2 = fabL + Math.min(i, fabW), y2 = fabT + Math.max(0, i - fabW);
    if (x1 < fabL + fabW && x2 > fabL) svg += '<line x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'" stroke="var(--hfc-text-tertiary)" stroke-width="0.35" opacity="0.5"/>';
    // Opposite diagonal
    var ax1 = fabL + fabW - Math.max(0, i - fabH), ay1 = fabT + Math.min(i, fabH);
    var ax2 = fabL + fabW - Math.min(i, fabW), ay2 = fabT + Math.max(0, i - fabW);
    if (ax1 > fabL && ax2 < fabL + fabW) svg += '<line x1="'+ax1+'" y1="'+ay1+'" x2="'+ax2+'" y2="'+ay2+'" stroke="var(--hfc-text-tertiary)" stroke-width="0.35" opacity="0.5"/>';
  }
  svg += '<text x="'+(fabL+fabW/2)+'" y="'+(fabT+fabH/2+3)+'" font-size="9" fill="var(--hfc-text-tertiary)" font-weight="500" text-anchor="middle" opacity="0.7">FABRIC</text>';

  // Bottom rail
  var bRailY = fabT + fabH - 1;
  svg += '<rect x="'+railL+'" y="'+bRailY+'" width="'+(railR-railL)+'" height="3.5" fill="var(--hfc-blue)" stroke="var(--hfc-blue-dark)" stroke-width="0.5" rx="1.5"/>';
  svg += '<text x="'+(railR+4)+'" y="'+(bRailY+3)+'" font-size="8" fill="var(--hfc-text-tertiary)" font-weight="500">BTM RAIL</text>';

  // Grade line
  svg += '<line x1="20" y1="'+gradeY+'" x2="'+(W-20)+'" y2="'+gradeY+'" stroke="var(--hfc-ok)" stroke-width="2" stroke-dasharray="8,4"/>';
  svg += '<text x="'+(W-18)+'" y="'+(gradeY+4)+'" font-size="9" fill="var(--hfc-ok)" font-weight="700">GRADE</text>';

  // ── Dimension: fence height (left) ──
  var dimX = 38;
  svg += dimLine(dimX, postTop, dimX, gradeY, hFt.toFixed(1)+"'", true);

  // ── Dimension: embedment (left) ──
  svg += dimLine(dimX, gradeY, dimX, gradeY + belowH, (embedIn).toFixed(0)+'"', true);

  // ── Dimension: footing diameter (bottom) ──
  var dimBotY = gradeY + belowH + 16;
  svg += dimLine(ftgL, dimBotY, ftgR, dimBotY, ftgDia.toFixed(0)+'" DIA', false);

  // ── Dimension: spacing (top) ──
  var spcY = postTop - 20;
  svg += dimLine(cx, spcY, cx + fabW + postW/2 + 3, spcY, sFt+'\' O.C.', false);

  // Post label
  svg += '<text x="'+cx+'" y="'+(postTop - 30)+'" font-size="11" fill="var(--hfc-blue)" font-weight="700" text-anchor="middle">'+postLabel+'</text>';

  // Concrete label
  svg += '<text x="'+(ftgR + 8)+'" y="'+(gradeY + belowH/2 - 4)+'" font-size="8" fill="var(--hfc-text-secondary)" font-weight="600">CONC.</text>';
  svg += '<text x="'+(ftgR + 8)+'" y="'+(gradeY + belowH/2 + 6)+'" font-size="8" fill="var(--hfc-text-secondary)" font-weight="600">PIER</text>';

  // Soil label
  svg += '<text x="'+(W - 50)+'" y="'+(gradeY + belowH/2)+'" font-size="8" fill="var(--hfc-text-tertiary)" font-weight="500">SOIL</text>';

  svg += '</svg>';
  el.innerHTML = svg;
}

function dimLine(x1,y1,x2,y2, label, vertical) {
  var s = '';
  if (vertical) {
    var mx = x1 - 14;
    s += '<line x1="'+mx+'" y1="'+y1+'" x2="'+mx+'" y2="'+y2+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    s += '<line x1="'+(mx-4)+'" y1="'+y1+'" x2="'+(mx+4)+'" y2="'+y1+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    s += '<line x1="'+(mx-4)+'" y1="'+y2+'" x2="'+(mx+4)+'" y2="'+y2+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    // Arrowheads
    s += '<polygon points="'+mx+','+y1+' '+(mx-2)+','+(y1+5)+' '+(mx+2)+','+(y1+5)+'" fill="var(--hfc-text)"/>';
    s += '<polygon points="'+mx+','+y2+' '+(mx-2)+','+(y2-5)+' '+(mx+2)+','+(y2-5)+'" fill="var(--hfc-text)"/>';
    var cy = (y1+y2)/2;
    s += '<text x="'+(mx-3)+'" y="'+(cy+4)+'" font-size="10" fill="var(--hfc-text)" font-weight="600" text-anchor="end" transform="rotate(-90,'+(mx-3)+','+cy+')">'+label+'</text>';
  } else {
    var my = y1;
    s += '<line x1="'+x1+'" y1="'+my+'" x2="'+x2+'" y2="'+my+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    s += '<line x1="'+x1+'" y1="'+(my-4)+'" x2="'+x1+'" y2="'+(my+4)+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    s += '<line x1="'+x2+'" y1="'+(my-4)+'" x2="'+x2+'" y2="'+(my+4)+'" stroke="var(--hfc-text)" stroke-width="0.6"/>';
    s += '<polygon points="'+x1+','+my+' '+(x1+5)+','+(my-2)+' '+(x1+5)+','+(my+2)+'" fill="var(--hfc-text)"/>';
    s += '<polygon points="'+x2+','+my+' '+(x2-5)+','+(my-2)+' '+(x2-5)+','+(my+2)+'" fill="var(--hfc-text)"/>';
    var cx = (x1+x2)/2;
    s += '<text x="'+cx+'" y="'+(my-6)+'" font-size="10" fill="var(--hfc-text)" font-weight="600" text-anchor="middle">'+label+'</text>';
  }
  return s;
}

/* ── Live calculation ────────────────────────────────────── */
var _calcTimer = null;
function liveCalc() {
  clearTimeout(_calcTimer);
  _calcTimer = setTimeout(function() {
    var body = Object.assign({}, _baseData);
    body.height_total_ft = parseFloat(document.getElementById('rng_height').value);
    body.post_spacing_ft = parseFloat(document.getElementById('rng_spacing').value);
    var lk = document.getElementById('sel_line_post').value;
    var tk = document.getElementById('sel_term_post').value;
    if (lk && lk !== 'auto') body.line_post_key = lk;
    if (tk && tk !== 'auto') body.terminal_post_key = tk;
    fetch('/api/v1/estimate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)})
    .then(function(r){return r.json();})
    .then(function(d){ renderAll(d); })
    .catch(function(){});
  }, 200);
}

/* ── Scenarios ───────────────────────────────────────────── */
function saveScenario(){
  var n=document.getElementById('scenario_name').value.trim();
  if(!n){alert('Enter a name.');return;}
  var d=_lastResult, s=d.shared;
  var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]');
  sc.push({name:n,ts:new Date().toISOString(),d:{ws:s.pressure_psf?_baseData.wind_speed_mph:0,
    h:document.getElementById('rng_height').value,
    s:document.getElementById('rng_spacing').value,
    p:s.pressure_psf.toFixed(1),st:d.overall_status,
    lp:d.line.recommended.post_label||'Auto',tp:d.terminal.recommended.post_label||'Auto'}});
  localStorage.setItem('wlc_scenarios',JSON.stringify(sc));
  document.getElementById('scenario_name').value='';renderSc();
}
function delSc(i){var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]');sc.splice(i,1);localStorage.setItem('wlc_scenarios',JSON.stringify(sc));renderSc();}
function renderSc(){
  var sc=JSON.parse(localStorage.getItem('wlc_scenarios')||'[]'),el=document.getElementById('saved_scenarios_list');
  if(!sc.length){el.innerHTML='<p class="text-muted" style="font-size:0.82rem;">No saved scenarios.</p>';return;}
  var h='<table class="data-table" style="font-size:0.82rem;"><tr><th style="text-align:left;">Name</th><th>Height</th><th>Spacing</th><th>Pressure</th><th>Status</th><th></th></tr>';
  sc.forEach(function(s,i){
    var cls=s.d.st==='GREEN'?'color-ok':(s.d.st==='YELLOW'?'color-warn':'color-fail');
    h+='<tr><td style="text-align:left;">'+s.name+'</td><td>'+s.d.h+'</td><td>'+s.d.s+'</td><td>'+s.d.p+'</td><td class="'+cls+'" style="font-weight:600;">'+s.d.st+'</td><td><button onclick="delSc('+i+')" style="border:none;background:none;color:var(--hfc-red);cursor:pointer;">&times;</button></td></tr>';
  });
  el.innerHTML=h+'</table>';
}

/* ── Initial render ──────────────────────────────────────── */
renderAll(_lastResult);
renderSc();
</script>

{% endblock %}
