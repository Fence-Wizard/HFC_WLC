{% extends "base.html" %}

{% block title %}Results | HFC Windload Calculator{% endblock %}

{% block progress %}
<div class="progress-bar">
  <div class="progress-bar-inner">
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Wind</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Geometry</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step completed">
      <span class="progress-dot">&#10003;</span>
      <span>Job Info</span>
    </div>
    <div class="progress-connector completed"></div>
    <div class="progress-step active">
      <span class="progress-dot">4</span>
      <span>Results</span>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}

<!-- ===== Overall Status Banner ===== -->
{% set status_class = {
  "GREEN": "status-green",
  "YELLOW": "status-yellow",
  "RED": "status-red"
}.get(result.overall_status, "status-green") %}

{% set status_icon = {
  "GREEN": "&#10004;",
  "YELLOW": "&#9888;",
  "RED": "&#10060;"
}.get(result.overall_status, "&#10004;") %}

{% set status_title = {
  "GREEN": "Within Limits",
  "YELLOW": "Marginal - Review Carefully",
  "RED": "Exceeds Limits - Action Required"
}.get(result.overall_status, "Results") %}

{% set status_desc = {
  "GREEN": "The requested post spacing is within the allowable limits for the selected wind speed and exposure.",
  "YELLOW": "The requested configuration is near the edge of allowable limits. Consider reducing post spacing or using heavier posts.",
  "RED": "The requested post spacing exceeds the allowable maximum. Reduce spacing, increase post size, or consult the project engineer."
}.get(result.overall_status, "") %}

<div class="status-banner {{ status_class }}">
  <span class="status-icon">{{ status_icon }}</span>
  <div class="status-body">
    <h3>{{ status_title }}</h3>
    <p>{{ status_desc }}</p>
  </div>
</div>

<!-- ===== Quick Summary Tiles ===== -->
<div class="results-grid">
  <div class="result-tile">
    <div class="result-value">{{ "%.1f"|format(result.shared.pressure_psf) }}</div>
    <div class="result-label">Wind Pressure</div>
    <div class="result-unit">psf</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.0f"|format(result.shared.total_load_lb) }}</div>
    <div class="result-label">Bay Load</div>
    <div class="result-unit">lb</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.0f"|format(result.shared.load_per_post_lb) }}</div>
    <div class="result-label">Per Post</div>
    <div class="result-unit">lb</div>
  </div>
  <div class="result-tile">
    <div class="result-value">{{ "%.1f"|format(result.shared.area_per_bay_ft2) }}</div>
    <div class="result-label">Bay Area</div>
    <div class="result-unit">ft&sup2;</div>
  </div>
</div>

<!-- ===== Input Parameters Card ===== -->
<div class="card">
  <div class="card-header">
    <h2>Input Parameters</h2>
    {% if data.project_name %}
    <p>{{ data.project_name }}{% if data.location %} &mdash; {{ data.location }}{% endif %}</p>
    {% endif %}
  </div>
  <table class="data-table">
    <tr>
      <td>Wind Speed</td>
      <td>{{ data.wind_speed_mph }} mph</td>
    </tr>
    <tr>
      <td>Exposure Category</td>
      <td>{{ data.exposure }}</td>
    </tr>
    <tr>
      <td>Risk Category</td>
      <td>{{ data.risk_category }}</td>
    </tr>
    <tr>
      <td>Fence Height</td>
      <td>{{ data.height_total_ft }} ft</td>
    </tr>
    <tr>
      <td>Post Spacing</td>
      <td>{{ data.post_spacing_ft }} ft</td>
    </tr>
    {% if data.fence_type %}
    <tr>
      <td>Fence Type</td>
      <td>{{ data.fence_type | replace("_", " ") | title }}</td>
    </tr>
    {% endif %}
    {% if data.estimator %}
    <tr>
      <td>Estimator</td>
      <td>{{ data.estimator }}</td>
    </tr>
    {% endif %}
  </table>
</div>

<!-- ===== ASCE 7-22 Calculation Breakdown ===== -->
{% if result.shared.design_params %}
{% set dp = result.shared.design_params %}
<div class="card">
  <details>
    <summary style="font-size: 1rem; font-weight: 600; color: var(--hfc-blue-dark);">
      ASCE 7-22 Calculation Breakdown
    </summary>
    <div class="detail-content" style="margin-top: 0.75rem;">
      <p class="text-sm text-muted" style="margin-bottom: 0.75rem;">
        <b>{{ dp.asce7_edition }}</b> &mdash; Velocity pressure and force coefficients
        for freestanding fences and walls.
      </p>

      <h4 style="margin: 0.75rem 0 0.5rem; font-size: 0.92rem;">Velocity Pressure</h4>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-bg); padding: 0.5rem 0.75rem; border-radius: 4px;">
        q<sub>z</sub> = 0.00256 &times; K<sub>z</sub> &times; K<sub>zt</sub>
        &times; K<sub>d</sub> &times; V&sup2;
        = 0.00256 &times; {{ "%.3f"|format(dp.kz) }}
        &times; {{ dp.kzt }}
        &times; {{ dp.kd }}
        &times; {{ data.wind_speed_mph }}&sup2;
        = <b>{{ "%.2f"|format(dp.qz_psf) }} psf</b>
      </p>

      <h4 style="margin: 0.75rem 0 0.5rem; font-size: 0.92rem;">Design Pressure</h4>
      <p class="text-sm" style="font-family: monospace; background: var(--hfc-bg); padding: 0.5rem 0.75rem; border-radius: 4px;">
        p = q<sub>z</sub> &times; G &times; C<sub>f</sub>
        = {{ "%.2f"|format(dp.qz_psf) }}
        &times; {{ dp.g }}
        &times; {{ "%.3f"|format(dp.cf) }}
        = <b>{{ "%.2f"|format(result.shared.pressure_psf) }} psf</b>
      </p>

      <table class="data-table" style="margin-top: 0.75rem;">
        <tr>
          <td>K<sub>z</sub> (exposure coefficient)</td>
          <td>{{ "%.4f"|format(dp.kz) }}</td>
        </tr>
        <tr>
          <td>K<sub>zt</sub> (topographic factor)</td>
          <td>{{ dp.kzt }}</td>
        </tr>
        <tr>
          <td>K<sub>d</sub> (directionality factor)</td>
          <td>{{ dp.kd }}</td>
        </tr>
        <tr>
          <td>G (gust-effect factor)</td>
          <td>{{ dp.g }}</td>
        </tr>
        <tr>
          <td>C<sub>f,solid</sub> (solid wall, B/s &ge; 20)</td>
          <td>{{ "%.3f"|format(dp.cf_solid) }}</td>
        </tr>
        <tr>
          <td>Solidity ratio &epsilon;</td>
          <td>{{ "%.2f"|format(dp.solidity) }}</td>
        </tr>
        <tr>
          <td>C<sub>f</sub> (net, C<sub>f,solid</sub> &times; &epsilon;)</td>
          <td>{{ "%.3f"|format(dp.cf) }}</td>
        </tr>
        <tr>
          <td>q<sub>z</sub> (velocity pressure)</td>
          <td>{{ "%.2f"|format(dp.qz_psf) }} psf</td>
        </tr>
      </table>

      <p class="text-muted text-sm" style="margin-top: 0.75rem;">
        Reference: {{ dp.asce7_edition }}, Eq. 26.10-1, Table 26.6-1,
        Section 26.11, Figure 29.3-1.
      </p>
    </div>
  </details>
</div>
{% endif %}

<!-- ===== Line Post Results ===== -->
<div class="card">
  <div class="card-header">
    <h2>
      <span class="tag tag-line">Line</span>
      Line Post
    </h2>
    <p>Intermediate posts along the fence run.</p>
  </div>

  <div class="post-block">
    <table class="data-table">
      <tr>
        <td>Recommended Post</td>
        <td>{{ result.line.recommended.post_label or result.line.recommended.post_key or "N/A" }}</td>
      </tr>
      {% if result.line.max_spacing_ft %}
      <tr>
        <td>Max Allowable Spacing</td>
        <td>{{ "%.2f"|format(result.line.max_spacing_ft) }} ft</td>
      </tr>
      {% endif %}
      {% if result.line.recommended.footing_diameter_in %}
      <tr>
        <td>Footing Diameter</td>
        <td>{{ result.line.recommended.footing_diameter_in }}"</td>
      </tr>
      {% endif %}
      {% if result.line.recommended.embedment_in %}
      <tr>
        <td>Embedment Depth</td>
        <td>{{ result.line.recommended.embedment_in }}"</td>
      </tr>
      {% endif %}
      <tr>
        <td>Status</td>
        <td>
          {% if result.line.status == "GREEN" %}
          <span style="color: #1a7a35; font-weight: 600;">&#10004; OK</span>
          {% elif result.line.status == "YELLOW" %}
          <span style="color: #b07d00; font-weight: 600;">&#9888; Marginal</span>
          {% else %}
          <span style="color: var(--hfc-red); font-weight: 600;">&#10060; Exceeds</span>
          {% endif %}
        </td>
      </tr>
    </table>

    {% if result.line.M_demand_ft_lb and result.line.M_allow_ft_lb %}
    <details>
      <summary>Bending Check (Advisory)</summary>
      <div class="detail-content">
        <p>
          Simplified cantilever bending analysis:<br />
          <b>M<sub>demand</sub></b> = {{ "%.1f"|format(result.line.M_demand_ft_lb) }} ft-lb
          &nbsp;|&nbsp;
          <b>M<sub>allow</sub></b> = {{ "%.1f"|format(result.line.M_allow_ft_lb) }} ft-lb
          &nbsp;|&nbsp;
          <b>Utilization</b>: {{ "%.0f"|format(result.line.M_demand_ft_lb / result.line.M_allow_ft_lb * 100) }}%
        </p>
        <p class="text-muted text-sm">
          This is a conservative cantilever estimate for reference only.
          Line post status is determined by the spacing table lookup.
        </p>
      </div>
    </details>
    {% endif %}
  </div>

  {% if result.line.warnings %}
  <ul class="warnings-list">
    {% for w in result.line.warnings %}
    <li>{{ w }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<!-- ===== Terminal Post Results ===== -->
<div class="card">
  <div class="card-header">
    <h2>
      <span class="tag tag-terminal">Terminal</span>
      Terminal / End / Corner Post
    </h2>
    <p>End posts, gate posts, and corner posts.</p>
  </div>

  <div class="post-block">
    <table class="data-table">
      <tr>
        <td>Recommended Post</td>
        <td>{{ result.terminal.recommended.post_label or result.terminal.recommended.post_key or "N/A" }}</td>
      </tr>
      {% if result.terminal.max_spacing_ft %}
      <tr>
        <td>Max Allowable Spacing</td>
        <td>{{ "%.2f"|format(result.terminal.max_spacing_ft) }} ft</td>
      </tr>
      {% endif %}
      {% if result.terminal.recommended.footing_diameter_in %}
      <tr>
        <td>Footing Diameter</td>
        <td>{{ result.terminal.recommended.footing_diameter_in }}"</td>
      </tr>
      {% endif %}
      {% if result.terminal.recommended.embedment_in %}
      <tr>
        <td>Embedment Depth</td>
        <td>{{ result.terminal.recommended.embedment_in }}"</td>
      </tr>
      {% endif %}
      <tr>
        <td>Status</td>
        <td>
          {% if result.terminal.status == "GREEN" %}
          <span style="color: #1a7a35; font-weight: 600;">&#10004; OK</span>
          {% elif result.terminal.status == "YELLOW" %}
          <span style="color: #b07d00; font-weight: 600;">&#9888; Marginal</span>
          {% else %}
          <span style="color: var(--hfc-red); font-weight: 600;">&#10060; Exceeds</span>
          {% endif %}
        </td>
      </tr>
    </table>

    {% if result.terminal.M_demand_ft_lb and result.terminal.M_allow_ft_lb %}
    <details>
      <summary>Bending Check</summary>
      <div class="detail-content">
        <p>
          <b>M<sub>demand</sub></b> = {{ "%.1f"|format(result.terminal.M_demand_ft_lb) }} ft-lb
          &nbsp;|&nbsp;
          <b>M<sub>allow</sub></b> = {{ "%.1f"|format(result.terminal.M_allow_ft_lb) }} ft-lb
          &nbsp;|&nbsp;
          <b>Utilization</b>: {{ "%.0f"|format(result.terminal.M_demand_ft_lb / result.terminal.M_allow_ft_lb * 100) }}%
        </p>
        {% if not result.terminal.moment_ok %}
        <p class="text-red text-sm">
          Terminal post bending demand exceeds allowable capacity.
          Consider upgrading to a heavier section.
        </p>
        {% endif %}
      </div>
    </details>
    {% endif %}
  </div>

  {% if result.terminal.warnings %}
  <ul class="warnings-list">
    {% for w in result.terminal.warnings %}
    <li>{{ w }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<!-- ===== Risk Details (if any) ===== -->
{% if risk_details and risk_details.reasons %}
<div class="card">
  <div class="card-header">
    <h2>Assessment Details</h2>
  </div>
  <ul class="warnings-list">
    {% for reason in risk_details.reasons %}
    <li>{{ reason }}</li>
    {% endfor %}
  </ul>
  {% if risk_details.advanced_reasons %}
  <details>
    <summary>Advanced Notes</summary>
    <div class="detail-content">
      <ul>
        {% for ar in risk_details.advanced_reasons %}
        <li>{{ ar }}</li>
        {% endfor %}
      </ul>
    </div>
  </details>
  {% endif %}
</div>
{% endif %}

<!-- ===== Assumptions ===== -->
{% set all_assumptions = result.line.assumptions + result.terminal.assumptions %}
{% if all_assumptions %}
<div class="card">
  <details>
    <summary>Assumptions &amp; Notes</summary>
    <div class="detail-content">
      <ul>
        {% for a in all_assumptions %}
        <li>{{ a }}</li>
        {% endfor %}
      </ul>
    </div>
  </details>
</div>
{% endif %}

<!-- ===== Download PDF ===== -->
<div class="download-section">
  <p>Generate a detailed PDF report with these results for your project file.</p>
  <a
    class="btn btn-primary btn-lg"
    href="/download?zip_code={{ data.zip_code }}&risk_category={{ data.risk_category }}&wind_speed_mph={{ data.wind_speed_mph }}&exposure={{ data.exposure }}&height_total_ft={{ data.height_total_ft }}&post_spacing_ft={{ data.post_spacing_ft }}&job_name={{ data.project_name or data.job_name or 'Job' }}&soil_type={{ data.soil_type or 'default' }}&fence_type={{ data.fence_type or 'chain_link_open' }}"
  >
    Download PDF Report
  </a>
</div>

<!-- ===== Start Over ===== -->
<div class="text-center mt-2">
  <a href="/" class="btn btn-secondary">Start New Estimate</a>
</div>

{% endblock %}
