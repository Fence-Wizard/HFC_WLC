{% extends "base.html" %}
{% block content %}
<h2>Review & Results</h2>

<h3>Inputs</h3>
<ul>
  <li>ZIP code: {{ data.zip_code }}</li>
  <li>Risk category: {{ data.risk_category }}</li>
  <li>Wind: {{ data.wind_speed_mph }} mph</li>
  <li>Exposure: {{ data.exposure }}</li>
  <li>Height: {{ data.height_total_ft }} ft</li>
  <li>Post spacing: <strong>{{ data.post_spacing_ft }} ft</strong></li>
  <li>
    Post type (current):
    {{ data.post_size or result.recommended.post_size or "Auto (based on load)" }}
  </li>
  <li>Soil type: {{ data.soil_type }}</li>
  <li>Job: {{ data.job_name }}</li>
</ul>

<h3>Results</h3>
<ul>
  <li>Pressure: {{ "%.2f"|format(result.pressure_psf) }} psf</li>
  <li>Area per bay: <strong>{{ "%.1f"|format(result.area_per_bay_ft2) }} ft²</strong> (height × spacing = {{ data.height_total_ft }} × {{ data.post_spacing_ft }})</li>
  <li>Total load per bay: <strong>{{ "%.0f"|format(result.total_load_lb) }} lb</strong></li>
  <li>Load per post: <strong>{{ "%.0f"|format(result.load_per_post_lb) }} lb</strong></li>
  <li>
    Recommended post:
    {{ result.recommended.post_size or 'N/A' }}
  </li>
  <li>
    Footing:
    {{ result.recommended.footing_diameter_in or 'N/A' }} in dia ×
    {{ result.recommended.embedment_in or 'N/A' }} in deep
  </li>
</ul>

{% if result.max_spacing_ft %}
  <p>
    <strong>Max recommended spacing for this post at these conditions:</strong>
    approx {{ "%.2f"|format(result.max_spacing_ft) }} ft.
  </p>

  {% if data.post_spacing_ft > result.max_spacing_ft %}
    <p style="font-weight: bold;">
      ⚠ Current spacing {{ "%.2f"|format(data.post_spacing_ft) }} ft exceeds this limit.
      Consider tightening spacing or increasing post size.
    </p>
  {% endif %}
{% endif %}

<h3>Try a different spacing / post type</h3>
<form method="post" action="/review" enctype="multipart/form-data">
  <!-- Keep all existing inputs as hidden so the calculation stays tied to the same job -->
  <input type="hidden" name="zip_code" value="{{ data.zip_code }}" />
  <input type="hidden" name="risk_category" value="{{ data.risk_category }}" />
  <input type="hidden" name="wind_speed_mph" value="{{ data.wind_speed_mph }}" />
  <input type="hidden" name="exposure" value="{{ data.exposure }}" />
  <input type="hidden" name="height_total_ft" value="{{ data.height_total_ft }}" />
  <input type="hidden" name="soil_type" value="{{ data.soil_type }}" />
  <input type="hidden" name="job_name" value="{{ data.job_name }}" />

  <label for="post_spacing_ft">Post spacing (ft):</label>
  <input
    type="number"
    id="post_spacing_ft"
    name="post_spacing_ft"
    step="0.1"
    min="2"
    max="20"
    value="{{ data.post_spacing_ft }}"
    required
  />

  <label for="post_size">Post type:</label>
  <select id="post_size" name="post_size">
    {% set current_post = data.post_size or result.recommended.post_size or "" %}
    <option value="" {% if not current_post %}selected{% endif %}>Auto (based on load)</option>
    <option value='2-3/8" SS40' {% if current_post == '2-3/8" SS40' %}selected{% endif %}>
      2-3/8" SS40
    </option>
    <option value='2-7/8" SS40' {% if current_post == '2-7/8" SS40' %}selected{% endif %}>
      2-7/8" SS40
    </option>
    <option value='3-1/2" SS40' {% if current_post == '3-1/2" SS40' %}selected{% endif %}>
      3-1/2" SS40
    </option>
  </select>

  <button type="submit">Recalculate</button>
</form>

<h3>Risk level</h3>
{% if risk == "GREEN" %}
<p style="color: green;">GREEN – Within table-based recommendations.</p>
{% elif risk == "YELLOW" %}
<p style="color: orange;">YELLOW – Review warnings carefully.</p>
{% else %}
<p style="color: red;">RED – Outside table bounds. PE review required.</p>
{% endif %}

{% if result.warnings %}
<h3>Warnings</h3>
<ul>
  {% for w in result.warnings %}
  <li>{{ w }}</li>
  {% endfor %}
</ul>
{% endif %}

{% if result.assumptions %}
<h3>Assumptions</h3>
<ul>
  {% for a in result.assumptions %}
  <li>{{ a }}</li>
  {% endfor %}
</ul>
{% endif %}

<h3>PDF</h3>
<a
  href="/download?zip_code={{ data.zip_code }}&risk_category={{ data.risk_category }}&wind_speed_mph={{ data.wind_speed_mph }}&exposure={{ data.exposure }}&height_total_ft={{ data.height_total_ft }}&post_spacing_ft={{ data.post_spacing_ft }}&soil_type={{ data.soil_type }}&job_name={{ data.job_name }}{% if data.post_size %}&post_size={{ data.post_size }}{% endif %}"
  >Download PDF report</a
>

{% endblock %}
