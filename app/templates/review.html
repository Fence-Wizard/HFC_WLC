{% extends "base.html" %}
{% block content %}
<h2>Review & Results</h2>

<h3>Inputs</h3>
<ul>
  <li>ZIP code: {{ data.zip_code }}</li>
  <li>Risk category: {{ data.risk_category }}</li>
  <li>Wind: {{ data.wind_speed_mph }} mph</li>
  <li>Exposure: {{ data.exposure }}</li>
  <li>Height: {{ data.height_total_ft }} ft</li>
  <li>Post spacing: <strong>{{ data.post_spacing_ft }} ft</strong></li>
  {% set current_post_key = data.post_key or result.recommended.post_key or "" %}
  {% set current_post_label = post_labels.get(current_post_key) or result.recommended.post_label %}
  <li>
    Post type (current):
    {{ current_post_label or "Auto (based on load)" }}
  </li>
  <li>Soil type: {{ data.soil_type }}</li>
  <li>Job: {{ data.job_name }}</li>
</ul>

<h3>Results</h3>
<ul>
  <li>Pressure: {{ "%.2f"|format(result.pressure_psf) }} psf</li>
  <li>Area per bay: <strong>{{ "%.1f"|format(result.area_per_bay_ft2) }} ft²</strong> (height × spacing = {{ data.height_total_ft }} × {{ data.post_spacing_ft }})</li>
  <li>Total load per bay: <strong>{{ "%.0f"|format(result.total_load_lb) }} lb</strong></li>
  <li>Load per post: <strong>{{ "%.0f"|format(result.load_per_post_lb) }} lb</strong></li>
  <li>
    Recommended post:
    {{ result.recommended.post_label or result.recommended.post_key or 'N/A' }}
  </li>
  <li>
    Footing:
    {{ result.recommended.footing_diameter_in or 'N/A' }} in dia ×
    {{ result.recommended.embedment_in or 'N/A' }} in deep
  </li>
</ul>

{% if result.max_spacing_ft %}
  <p>
    <strong>Max recommended spacing for this post at these conditions:</strong>
    approx {{ "%.2f"|format(result.max_spacing_ft) }} ft.
  </p>

  {% if data.post_spacing_ft > result.max_spacing_ft %}
    <p style="font-weight: bold;">
      ⚠ Current spacing {{ "%.2f"|format(data.post_spacing_ft) }} ft exceeds this limit.
      Consider tightening spacing or increasing post size.
    </p>
  {% endif %}
{% endif %}

<h3>Try a different spacing / post type</h3>
<form method="post" action="/review" enctype="multipart/form-data">
  <!-- Keep all existing inputs as hidden so the calculation stays tied to the same job -->
  <input type="hidden" name="zip_code" value="{{ data.zip_code }}" />
  <input type="hidden" name="risk_category" value="{{ data.risk_category }}" />
  <input type="hidden" name="wind_speed_mph" value="{{ data.wind_speed_mph }}" />
  <input type="hidden" name="exposure" value="{{ data.exposure }}" />
  <input type="hidden" name="height_total_ft" value="{{ data.height_total_ft }}" />
  <input type="hidden" name="soil_type" value="{{ data.soil_type }}" />
  <input type="hidden" name="job_name" value="{{ data.job_name }}" />
  <!-- Legacy post_size preserved for backward compatibility but not used for selection -->
  <input type="hidden" name="post_size" value="{{ data.post_size }}" />
  <input type="hidden" name="post_role" value="{{ data.post_role }}" />

  <label for="post_spacing_ft">Post spacing (ft):</label>
  <input
    type="number"
    id="post_spacing_ft"
    name="post_spacing_ft"
    step="0.1"
    min="2"
    max="20"
    value="{{ data.post_spacing_ft }}"
    required
  />

  <label for="line_post_key">Line post type:</label>
  <select id="line_post_key" name="line_post_key">
    {% set current_line_post = data.line_post_key or "auto" %}
    <option value="auto" {% if current_line_post == "auto" %}selected{% endif %}>
      Auto (based on load)
    </option>

    {% for opt in post_options %}
    <option value="{{ opt.key }}"
      {% if opt.key == current_line_post %}selected{% endif %}>
      {{ opt.label }}
    </option>
    {% endfor %}
  </select>

  <label for="terminal_post_key">Terminal post type:</label>
  <select id="terminal_post_key" name="terminal_post_key">
    {% set current_terminal_post = data.terminal_post_key or "auto" %}
    <option value="auto" {% if current_terminal_post == "auto" %}selected{% endif %}>
      Auto (based on load)
    </option>

    {% for opt in post_options %}
    <option value="{{ opt.key }}"
      {% if opt.key == current_terminal_post %}selected{% endif %}>
      {{ opt.label }}
    </option>
    {% endfor %}
  </select>

  <button type="submit">Recalculate</button>
</form>

<h3>Shared Results</h3>
<ul>
  <li>Pressure: {{ "%.2f"|format(result.shared.pressure_psf) }} psf</li>
  <li>Area per bay: {{ "%.1f"|format(result.shared.area_per_bay_ft2) }} ft²</li>
  <li>Total load per bay: {{ "%.0f"|format(result.shared.total_load_lb) }} lb</li>
  <li>Load per post: {{ "%.0f"|format(result.shared.load_per_post_lb) }} lb</li>
</ul>

<h3>Line Results</h3>
<ul>
  <li>Post: {{ result.line.post_label or result.line.post_key or 'Auto' }}</li>
  {% if result.line.max_spacing_ft %}
  <li>Max spacing: {{ "%.2f"|format(result.line.max_spacing_ft) }} ft</li>
  <li>Your spacing: {{ "%.2f"|format(data.post_spacing_ft) }} ft</li>
  {% endif %}
  <li>Bending: Bending check (conservative) available in Advanced.</li>
</ul>
{% if result.line.max_spacing_ft %}
  {% set spacing_ratio = data.post_spacing_ft / result.line.max_spacing_ft %}
  <p><strong>Line spacing ratio:</strong> {{ "%.1f"|format(spacing_ratio * 100) }}% ({{ "%.2f"|format(data.post_spacing_ft) }} / {{ "%.2f"|format(result.line.max_spacing_ft) }})</p>
{% endif %}
{% if result.line.M_demand_ft_lb is not none and result.line.M_allow_ft_lb is not none %}
<details>
  <summary>Advanced (line post)</summary>
  <p>Advisory — Simplified cantilever bending check (conservative): {{ "%.0f"|format(result.line.M_demand_ft_lb / result.line.M_allow_ft_lb * 100) }}%
     ({{ "%.1f"|format(result.line.M_demand_ft_lb) }} / {{ "%.1f"|format(result.line.M_allow_ft_lb) }} ft·lb)</p>
</details>
{% endif %}

<h3>Terminal Results</h3>
<ul>
  <li>Post: {{ result.terminal.post_label or result.terminal.post_key or 'Auto' }}</li>
  {% if result.terminal.recommended %}
  <li>Footing: {{ result.terminal.recommended.footing_diameter_in or 'N/A' }} in dia × {{ result.terminal.recommended.embedment_in or 'N/A' }} in</li>
  {% endif %}
  {% if result.terminal.M_demand_ft_lb is not none and result.terminal.M_allow_ft_lb is not none %}
  <li>Bending utilization: {{ "%.0f"|format(result.terminal.M_demand_ft_lb / result.terminal.M_allow_ft_lb * 100) }}%
     ({{ "%.1f"|format(result.terminal.M_demand_ft_lb) }} / {{ "%.1f"|format(result.terminal.M_allow_ft_lb) }} ft·lb)</li>
  {% endif %}
</ul>

<h3>Overall Status: {{ result.overall_status }}</h3>

{% endblock %}
