{% extends "base.html" %}

{% block title %}Step 1 - Wind | HFC Windload Calculator{% endblock %}

{% block progress %}
<div class="progress-bar">
  <div class="progress-bar-inner">
    <div class="progress-step active">
      <span class="progress-dot">1</span>
      <span>Wind</span>
    </div>
    <div class="progress-connector"></div>
    <div class="progress-step">
      <span class="progress-dot">2</span>
      <span>Geometry</span>
    </div>
    <div class="progress-connector"></div>
    <div class="progress-step">
      <span class="progress-dot">3</span>
      <span>Job Info</span>
    </div>
    <div class="progress-connector"></div>
    <div class="progress-step">
      <span class="progress-dot">4</span>
      <span>Results</span>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<form method="post" action="/step2">
  <div class="card">
    <div class="card-header">
      <h2>Step 1 - Wind Speed &amp; Exposure</h2>
      <p>Identify the design wind speed and exposure category for this project.</p>
    </div>

    <div class="form-group">
      <label for="zip_code">ZIP Code (installation location)</label>
      <input
        type="text"
        id="zip_code"
        name="zip_code"
        pattern="\d{5}"
        value="{{ data.zip_code or '' }}"
        placeholder="e.g. 23220"
        required
      />
    </div>

    <div class="form-group">
      <label for="risk_category">Risk Category</label>
      <select id="risk_category" name="risk_category">
        <option value="I" {% if data.risk_category=="I" %}selected{% endif %}>
          Risk Category I
        </option>
        <option value="III" {% if data.risk_category=="III" or not data.risk_category %}selected{% endif %}>
          Risk Category III
        </option>
      </select>
    </div>

    <div class="info-card">
      <strong>What is a Risk Category?</strong>
      <ul>
        <li><b>Risk Category I</b> - Low-risk, temporary, or minor structures.
          Usually appropriate for <b>temporary fence</b>, laydown yards,
          and non-essential work.</li>
        <li><b>Risk Category III</b> - Structures that pose higher risk to the
          public, or important to post-disaster response. Use only when
          drawings or engineer explicitly say Risk Cat III.</li>
      </ul>
      <p class="muted">
        When in doubt, <b>follow the project drawings</b> or confirm with the
        project manager / engineer.
      </p>
    </div>

    <div class="form-group">
      <label for="wind_speed_mph">Design Wind Speed V (mph)</label>
      <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
        <input
          type="number"
          id="wind_speed_mph"
          name="wind_speed_mph"
          step="1"
          min="60"
          max="250"
          value="{{ data.wind_speed_mph or '' }}"
          placeholder="e.g. 115"
          required
          style="flex: 1;"
        />
        <button type="button" id="lookup_btn" class="btn btn-secondary"
                style="white-space: nowrap; padding: 0.5rem 0.75rem; font-size: 0.85rem;"
                onclick="lookupWindSpeed()">
          Auto-fill from ZIP
        </button>
      </div>
      <span class="form-hint">
        3-second gust at 33 ft, from ASCE wind maps or project drawings.
        Click "Auto-fill" for an approximate value based on ZIP code and risk category.
      </span>
      <span id="lookup_result" class="form-hint" style="color: var(--hfc-blue); display: none;"></span>
    </div>

    <details>
      <summary>ASCE 7 Wind Maps (reference)</summary>
      <div class="detail-content">
        <p>Use the maps below (or the project drawings) to determine the basic
        wind speed <b>V</b> for the job location and risk category.</p>

        <h4 class="mt-1">Risk Category I (Figures 26.5-1A &amp; 26.5-1B)</h4>
        <div class="map-grid">
          <div class="map-card">
            <a href="/static/images/asce_26_5_1A_risk_I.png" target="_blank">
              <img src="/static/images/asce_26_5_1A_risk_I.png"
                alt="ASCE Figure 26.5-1A - Risk Category I (West/Alaska/Hawaii)" />
            </a>
            <div class="map-caption">
              <b>Figure 26.5-1A.</b> Western U.S., Alaska, Hawaii - Risk Category I.
            </div>
          </div>
          <div class="map-card">
            <a href="/static/images/asce_26_5_1B_risk_I_continued.png" target="_blank">
              <img src="/static/images/asce_26_5_1B_risk_I_continued.png"
                alt="ASCE Figure 26.5-1B - Risk Category I (Central/Eastern U.S.)" />
            </a>
            <div class="map-caption">
              <b>Figure 26.5-1B.</b> Central &amp; Eastern U.S. - Risk Category I.
            </div>
          </div>
        </div>

        <h4 class="mt-1">Risk Category III (Figures 26.5-1C)</h4>
        <div class="map-grid">
          <div class="map-card">
            <a href="/static/images/asce_26_5_1C_risk_III.png" target="_blank">
              <img src="/static/images/asce_26_5_1C_risk_III.png"
                alt="ASCE Figure 26.5-1C - Risk Category III" />
            </a>
            <div class="map-caption">
              <b>Figure 26.5-1C.</b> Central &amp; Eastern U.S. - Risk Category III.
            </div>
          </div>
          <div class="map-card">
            <a href="/static/images/asce_26_5_1C_risk_III_continued.png" target="_blank">
              <img src="/static/images/asce_26_5_1C_risk_III_continued.png"
                alt="ASCE Figure 26.5-1C continued" />
            </a>
            <div class="map-caption">
              Additional regions for Risk Category III.
            </div>
          </div>
        </div>

        <p class="muted mt-1">
          Click any map to open full-size. Use linear interpolation between
          contours. For special wind regions, use the value from drawings or
          confirm with the engineer.
        </p>
      </div>
    </details>

    <div class="form-group">
      <label for="exposure">Exposure Category</label>
      <select id="exposure" name="exposure">
        {% for exp in ["B","C","D"] %}
        <option
          value="{{ exp }}"
          {% if data.exposure==exp or (not data.exposure and exp=="C") %}selected{% endif %}
        >
          Exposure {{ exp }}
        </option>
        {% endfor %}
      </select>
      <span class="form-hint">
        <b>B</b> = Urban / suburban, many buildings or trees.
        <b>C</b> = Open terrain, scattered obstructions (most common).
        <b>D</b> = Flat, unobstructed areas near open water.
      </span>
    </div>

    <details style="margin-top: 1rem;">
      <summary style="font-weight: 600; cursor: pointer;">Advanced Parameters</summary>
      <div class="detail-content" style="margin-top: 0.75rem;">
        <div class="form-group">
          <label for="kzt">Topographic Factor K<sub>zt</sub></label>
          <input
            type="number"
            id="kzt"
            name="kzt"
            step="0.01"
            min="1.0"
            max="3.0"
            value="{{ data.kzt or '1.0' }}"
          />
          <span class="form-hint">
            1.0 for flat terrain (default). Increase for hilltops, ridges, or escarpments
            per ASCE 7-22 Section 26.8. Typical range 1.0-1.8.
          </span>
        </div>

        <div class="form-group">
          <label for="soil_type">Soil Type (for footing check)</label>
          <select id="soil_type" name="soil_type">
            <option value="default" {% if not data.soil_type or data.soil_type=='default' %}selected{% endif %}>
              Default - Stiff soil (conservative)
            </option>
            <option value="rock_crystalline" {% if data.soil_type=='rock_crystalline' %}selected{% endif %}>
              Crystalline bedrock (1200 psf/ft)
            </option>
            <option value="rock_sedimentary" {% if data.soil_type=='rock_sedimentary' %}selected{% endif %}>
              Sedimentary rock (400 psf/ft)
            </option>
            <option value="gravel" {% if data.soil_type=='gravel' %}selected{% endif %}>
              Sandy gravel, GW/GP (200 psf/ft)
            </option>
            <option value="sand" {% if data.soil_type=='sand' %}selected{% endif %}>
              Sand, silty sand, SW/SP/SM (150 psf/ft)
            </option>
            <option value="clay" {% if data.soil_type=='clay' %}selected{% endif %}>
              Clay, sandy clay, CL/ML (100 psf/ft)
            </option>
          </select>
          <span class="form-hint">
            Per IBC Table 1806.2. Used for lateral soil resistance check on footings.
          </span>
        </div>
      </div>
    </details>

    <div class="btn-group">
      <button type="submit" class="btn btn-primary btn-lg">
        Next &rarr;
      </button>
    </div>
  </div>
</form>

<script>
// ZIP code wind speed auto-lookup
function lookupWindSpeed() {
  var zip = document.getElementById('zip_code').value;
  var rc = document.getElementById('risk_category').value;
  var resultEl = document.getElementById('lookup_result');

  if (!zip || zip.length < 5) {
    resultEl.style.display = 'block';
    resultEl.style.color = 'var(--hfc-red)';
    resultEl.textContent = 'Enter a valid 5-digit ZIP code first.';
    return;
  }

  fetch('/api/v1/wind-speed-lookup?zip_code=' + zip + '&risk_category=' + rc)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.wind_speed_mph) {
        document.getElementById('wind_speed_mph').value = data.wind_speed_mph;
        resultEl.style.display = 'block';
        resultEl.style.color = 'var(--hfc-blue)';
        resultEl.textContent = 'Approx. ' + data.wind_speed_mph + ' mph for ' +
          data.region + ' (Risk Cat ' + rc + '). Verify with project drawings.';
        sessionStorage.setItem('step1_wind_speed_mph', data.wind_speed_mph);
      } else {
        resultEl.style.display = 'block';
        resultEl.style.color = 'var(--hfc-red)';
        resultEl.textContent = data.region || 'ZIP code not found in database.';
      }
    })
    .catch(function() {
      resultEl.style.display = 'block';
      resultEl.style.color = 'var(--hfc-red)';
      resultEl.textContent = 'Lookup failed. Enter wind speed manually.';
    });
}

// Persist form state in sessionStorage
(function() {
  var fields = ['zip_code','risk_category','wind_speed_mph','exposure','kzt','soil_type'];
  fields.forEach(function(f) {
    var el = document.getElementById(f);
    if (!el) return;
    var saved = sessionStorage.getItem('step1_' + f);
    if (saved && !el.value) el.value = saved;
    el.addEventListener('change', function() {
      sessionStorage.setItem('step1_' + f, el.value);
    });
    el.addEventListener('input', function() {
      sessionStorage.setItem('step1_' + f, el.value);
    });
  });
})();
</script>
{% endblock %}
